---
layout: post
title: 'Native Android Reverse Engineering Tutorial#1: Patching/Modifying String within
  Native Android App'
date: '2013-04-27T21:07:00.000+05:30'
author: Shubham Aher
tags:
- java
- ida
- linux
- cracking
- native android
- reverse engineering
- tutorial
- android
- ubuntu
modified_time: '2013-04-29T22:03:10.750+05:30'
thumbnail: http://2.bp.blogspot.com/-t2ChzmRelcY/UXlwGDNcfUI/AAAAAAAAAO8/UugZUMc_fO0/s72-c/nativetut1.png
blogger_id: tag:blogger.com,1999:blog-2487333153967243269.post-5268169391416190756
blogger_orig_url: http://shubhamaher.blogspot.com/2013/04/native-android-reverse-engineering.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br /><h4><u><b>Aim</b>:</u></h4><div dir="ltr" trbidi="on"><div trbidi="on">To learn to:<br /><ol><li>Decompile the <a href="http://developer.android.com/tools/sdk/ndk/index.html" target="_blank">Native&nbsp;Android </a>App File (.<b>apk</b>)&nbsp;into Java code (.java)</li><li>Disassemble the&nbsp;<a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html" target="_blank">Shared Object File (.so)</a>&nbsp;into&nbsp;<a href="http://infocenter.arm.com/help/index.jsp" target="_blank">ARM Assembler Opcodes</a>.</li><li>Use of tools like&nbsp;<a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA (Interactive Disassembler)</a>,&nbsp;<a href="http://code.google.com/p/dex2jar/" target="_blank">dex2jar</a>,&nbsp;<a href="http://java.decompiler.free.fr/?q=jdgui" target="_blank">jd-gui</a>, etc.</li></ol>This tutorial introduces you to the basics of&nbsp;<a href="http://en.wikipedia.org/wiki/Reverse_engineering" target="_blank">reverse engineering</a>&nbsp;a Native Android app on Ubuntu.</div></div><h4><u><br /></u></h4><h4><u>Prerequisite:</u></h4><ul style="text-align: left;"><li><a href="http://www.shubhamaher.blogspot.in/2013/01/android-reverse-engineering-tutorial1.html" target="_blank">http://www.shubhamaher.blogspot.in/2013/01/android-reverse-engineering-tutorial1.html</a></li><li>Knowledge of basic UNIX commands.</li></ul><ul></ul><div class="separator" style="clear: both; text-align: center;"></div><h4 style="text-align: left;"><u><br /></u></h4><h4 style="text-align: left;"><u>Tools Needed:</u></h4><ul style="text-align: left;"><li><a href="http://developer.android.com/sdk/index.html" target="_blank">Android SDK</a>&nbsp;(for adb and Emulators )</li><li>Dex2jar</li><li>AXMLPrinter2.jar (for converting a binary XML into textual XML)</li><li>jd-gui</li><li>signapk.jar (for re-signing the modified APK)</li></ul><h4 style="text-align: left;"><u><br /></u></h4><h4 style="text-align: left;"><u>Overview:</u></h4><ul style="text-align: left;"><li>The general overview of steps required to carry for <b><a href="http://en.wikipedia.org/wiki/Reverse_engineering" target="_blank">reversing </a></b>a Native Android app are:</li></ul><a href="http://2.bp.blogspot.com/-t2ChzmRelcY/UXlwGDNcfUI/AAAAAAAAAO8/UugZUMc_fO0/s1600/nativetut1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="492" src="http://2.bp.blogspot.com/-t2ChzmRelcY/UXlwGDNcfUI/AAAAAAAAAO8/UugZUMc_fO0/s640/nativetut1.png" width="640" /></a><br /><br /><u><b>Steps:</b></u><br /><div style="text-align: center;"><u><b>DOWNLOAD</b></u></div><div style="text-align: left;"><b>Step#1:</b></div><div style="text-align: left;">I have put together all the <b>tools </b>and the <b>target <a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme</a> <a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">APK </a></b><a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">file</a> in one <b>directory </b>called "<b>mycracklab</b>", zipped and uploaded it. Download the <b><a href="http://www.mediafire.com/download.php?t73xn9vamf4dgb5" target="_blank">mycracklab.zip</a></b> and extract it anywhere you like. I have the "<b>mycracklab</b>" directory at <b><i>/home/shubhuntu/mycracklab/</i></b></div><br /><span style="font-weight: bold; text-align: center; text-decoration: underline;"></span><br /><div style="text-align: center;"><span style="font-weight: bold; text-align: center; text-decoration: underline;">TESTING the TARGET CRACKME</span></div><br /><pre class="brush: shell"><br />$ pwd<br />/home/shubhuntu/mycracklab<br /><br />$ ls<br />crackme.native-1.apk &nbsp;tools<br /></pre><br /><b>Step#2:</b><br /><div>Viewing files in the <a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">APK</a>. An <b><a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">APK</a></b> is a <b><a href="http://en.wikipedia.org/wiki/Zip_(file_format)" target="_blank">ZIP file</a></b> with a .apk extension. So we use the "<b>zipinfo</b>" command.</div><pre class="brush: shell">$ zipinfo crackme.native-1.apk<br />Archive:  crackme.native-1.apk<br />Zip file size: 153346 bytes, number of entries: 8<br />-rw----     2.0 fat     1436 bX defN 13-Apr-08 16:45 AndroidManifest.xml<br />-rw----     1.0 fat      576 b- stor 13-Apr-08 16:45 resources.arsc<br />-rw----     2.0 fat     2924 bl defN 13-Apr-08 16:45 classes.dex<br />-rw----     2.0 fat   268812 bl defN 13-Mar-13 22:29 lib/armeabi/gdbserver<br />-rw----     2.0 fat    13432 bl defN 13-Apr-08 16:26 lib/armeabi/libhello-jni.so<br />-rw----     2.0 fat      409 bl defN 13-Apr-08 16:45 META-INF/MANIFEST.MF<br />-rw----     2.0 fat      462 bl defN 13-Apr-08 16:45 META-INF/CERT.SF<br />-rw----     2.0 fat     1203 bl defN 13-Apr-08 16:45 META-INF/CERT.RSA<br />8 files, 289254 bytes uncompressed, 152306 bytes compressed:  47.3%<br /></pre><br /><b>Step#3:</b><br />Starting the emulator.<br />Using the <b><a href="http://developer.android.com/tools/help/avd-manager.html" target="_blank">Android's AVD Manager</a></b> I have started an <b><a href="http://developer.android.com/tools/help/emulator.html" target="_blank">emulator</a></b> running <b><a href="http://www.android.com/about/jelly-bean/" target="_blank">Android 4.2</a></b> that is <b><a href="http://developer.android.com/about/versions/android-4.2.html" target="_blank">API Level 17</a></b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-byqIlH8RgB8/UXlttfoaFxI/AAAAAAAAANA/ozf1gzsOVT0/s1600/ss2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-byqIlH8RgB8/UXlttfoaFxI/AAAAAAAAANA/ozf1gzsOVT0/s1600/ss2.png" /></a></div><br /><b>Step#4:</b><br />Installing the APK in the emulator using <b><a href="http://developer.android.com/tools/help/adb.html" target="_blank">adb</a></b>.<br /><br />To install, I will use the <b><a href="http://developer.android.com/tools/help/adb.html" target="_blank">Android Debug Bridge i.e. adb</a></b> which is present in the "<b>platform-tools</b>" directory of the <b><a href="http://developer.android.com/sdk/index.html" target="_blank">Android SDK</a></b>. <br /><pre class="brush: shell"><br />$ cd /opt/android/adt-bundle-linux-x86/sdk/platform-tools/<br />shubhuntu@elf:/opt/android/adt-bundle-linux-x86/sdk/platform-tools$ ls<br />aapt  adb  aidl  api  dexdump  dx  fastboot  lib  llvm-rs-cc  NOTICE.txt  renderscript  source.properties<br /><br />$ ./adb install /home/shubhuntu/mycracklab/crackme.native-1.apk<br />987 KB/s (153346 bytes in 0.151s)<br /> pkg: /data/local/tmp/crackme.native-1.apk<br />Success<br /></pre><br /><br />If the command <b>succeeds</b>, that means it is <b>installed </b>and an <b>icon</b> for the <b>app </b>appears in the <b>menu </b>of <b>emulator</b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-OxQSVC2AxGk/UXltvYak5GI/AAAAAAAAANM/dkoqBFeHndE/s1600/ss3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-OxQSVC2AxGk/UXltvYak5GI/AAAAAAAAANM/dkoqBFeHndE/s1600/ss3.png" /></a></div><br /><b>Step#5:</b><br /><b>Click </b>on the app to start the <b><a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme</a></b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-JOYpc-T9GFo/UXltvZGW6AI/AAAAAAAAANQ/HNGPOn3O-Cw/s1600/ss4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-JOYpc-T9GFo/UXltvZGW6AI/AAAAAAAAANQ/HNGPOn3O-Cw/s1600/ss4.png" /></a></div>As seen the <b><a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme </a></b>displays the message "<b>Hello from JNI !</b>". Our aim is to <b>modify </b>this message <b><a href="https://en.wikipedia.org/wiki/String_(computer_science)" target="_blank">string</a></b>.<br />Let us begin our <b>hunt </b>for the <b>message</b>.<br /><b><span style="color: red;">Remember NOT to close the emulator !</span></b><br /><span style="font-weight: bold; text-align: center;"><br /></span><span style="font-weight: bold; text-align: center;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-weight: bold; text-align: center; text-decoration: underline;">DECOMPILATION (.dex to .jar to *.java files)</span><br /><div style="text-align: justify;"><span style="text-align: center;"><b>Step#6:</b></span></div><div style="text-align: left;"><span style="text-align: center;"><b>Extraction </b>of all the files from the <b><a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme </a><a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">APK</a></b>(which is actually a <b><a href="http://en.wikipedia.org/wiki/Zip_(file_format)" target="_blank">ZIP file</a></b>).</span></div><pre class="brush: shell"><br />$ cd /home/shubhuntu/mycracklab/<br />$ unzip -d extracted crackme.native-1.apk <br />Archive:  crackme.native-1.apk<br />  inflating: extracted/AndroidManifest.xml  <br /> extracting: extracted/resources.arsc  <br />  inflating: extracted/classes.dex   <br />  inflating: extracted/lib/armeabi/gdbserver  <br />  inflating: extracted/lib/armeabi/libhello-jni.so  <br />  inflating: extracted/META-INF/MANIFEST.MF  <br />  inflating: extracted/META-INF/CERT.SF  <br />  inflating: extracted/META-INF/CERT.RSA  <br /><br />$ cd extracted/<br />$ ls<br />AndroidManifest.xml  classes.dex  lib  META-INF  resources.arsc<br /></pre><div style="text-align: left;"><span style="text-align: center;"><br /></span><span style="text-align: center;"><b>Step#7:</b></span></div><div style="text-align: left;"><span style="text-align: center;"><b>Conversion </b>of the "<b><a href="http://stackoverflow.com/questions/14230573/role-of-classes-dex-file-in-an-apk-file" target="_blank">classes.dex</a></b>" file to "<b>classes-dex2jar.jar</b>" file.</span></div><div><pre class="brush: shell"><br />$ sh ../tools/dex2jar-0.0.9.13/d2j-dex2jar.sh classes.dex<br />dex2jar classes.dex -&gt; classes-dex2jar.jar<br /></pre><div style="text-align: left;"><span style="text-align: center;"><br /></span><span style="text-align: center;"><b>Step#8:</b></span></div><span style="text-align: center;"></span> <br /><div style="text-align: left;"><span style="text-align: center;"><b>Conversion </b>of the <b><a href="http://en.wikipedia.org/wiki/JAR_(file_format)" target="_blank">.jar file</a></b> to <b><a href="http://en.wikipedia.org/wiki/Java_(programming_language)" target="_blank">*.java files</a></b> using <b><a href="http://java.decompiler.free.fr/?q=jdgui" target="_blank">jd-gui</a> <a href="http://en.wikipedia.org/wiki/Java_(programming_language)" target="_blank">Java</a> <a href="https://en.wikipedia.org/wiki/Decompiler" target="_blank">decompiler</a></b>.</span><br /><span style="text-align: center;"><br /></span></div><div style="text-align: left;"><span style="text-align: center;"><b>Step#8.1:</b></span></div><span style="text-align: center;"></span> <br /><div style="text-align: left;"><span style="text-align: center;">Start the <b><a href="http://java.decompiler.free.fr/?q=jdgui" target="_blank">jd-gui tool</a>.</b></span></div><pre class="brush: shell"><br />$ jd-gui classes-dex2jar.jar &amp;<br />[1] 4371<br /></pre><div style="text-align: left;"><div><div><span style="text-align: center;"><br /></span><span style="text-align: center;"><b>Step#8.2:</b></span></div></div><div><div><span style="text-align: center;">Navigate to "<b>File</b>" <b>==&gt;</b> "<b>Save All Sources</b>" inside the <b><a href="http://java.decompiler.free.fr/?q=jdgui" target="_blank">jd-gui</a></b>.</span></div><div><span style="text-align: center;">Keep the <b>default filename </b>as it is: "<b>classes-dex2jar.src.zip</b>"</span></div><div><span style="text-align: center;">Click on "<b>Save</b>" button.</span></div></div><div><div><span style="text-align: center;"><br /></span><span style="text-align: center;"><b>Step#8.3:</b></span></div><div><span style="text-align: center;">Extraction of the <b><a href="http://en.wikipedia.org/wiki/Java_(programming_language)" target="_blank">*.java files</a></b> into a directory called "<b>javacode</b>"</span></div><pre class="brush: shell"><br />$ ls<br />AndroidManifest.xml  classes.dex  classes-dex2jar.jar  classes-dex2jar.src.zip  jd-gui.cfg  lib  META-INF  resources.arsc<br /><br />$ unzip classes-dex2jar.src.zip -d javacode<br />Archive:  classes-dex2jar.src.zip<br />   creating: javacode/android/<br />   creating: javacode/android/annotation/<br />  inflating: javacode/android/annotation/SuppressLint.java  <br />  inflating: javacode/android/annotation/TargetApi.java  <br />   creating: javacode/com/<br />   creating: javacode/com/example/<br />   creating: javacode/com/example/hellojni/<br />  inflating: javacode/com/example/hellojni/BuildConfig.java  <br />  inflating: javacode/com/example/hellojni/HelloJni.java  <br />  inflating: javacode/com/example/hellojni/R.java  <br /></pre><div><br /></div><div style="text-align: center;"><span style="text-align: center;"><b><u>IDENTIFYING the PACKAGES, CLASSES and METHODS to PATCH</u></b></span></div><div><span style="text-align: center;"><br /></span></div><div><span style="text-align: center;"><b>Step#9:</b></span></div><div><span style="text-align: center;">Converting the <b><a href="http://en.wikipedia.org/wiki/Binary_XML" target="_blank">Binary XML</a></b> into a <b><a href="http://en.wikipedia.org/wiki/XML" target="_blank">Textual XML</a></b> using <b>AXMLPrinter2.jar</b></span></div><pre class="brush: shell"><br />$ java -jar ../tools/AXMLPrinter2.jar AndroidManifest.xml &gt; AndroidManifest.xml.text<br /><br />$ ls<br />AndroidManifest.xml  AndroidManifest.xml.text  classes.dex  classes-dex2jar.jar  classes-dex2jar.src.zip  javacode  jd-gui.cfg  lib  META-INF  resources.arsc<br /><br />$ vim AndroidManifest.xml.text<br /></pre><br />This is how the <b><a href="http://en.wikipedia.org/wiki/XML" target="_blank">textual XML</a></b> will look: <br /><pre class="brush: shell"><br /><manifest android:versioncode="1" android:versionname="1.0" package="com.example.hellojni" xmlns:android="http://schemas.android.com/apk/res/android"><br /> <uses-sdk android:minsdkversion="3"><br /> </uses-sdk><br /> <application android:debuggable="true" android:label="@7F020000"><br />  <activity android:label="@7F020000" android:name=".HelloJni"><br />   <intent-filter><br />    <action android:name="android.intent.action.MAIN"><br />    </action><br />    <category android:name="android.intent.category.LAUNCHER"><br />    </category><br />   </intent-filter><br />  </activity><br /> </application><br /></manifest><br /></pre><span style="text-align: center;"><br /></span><span style="text-align: center;">We come to know that the <b>initial</b> <a href="http://developer.android.com/reference/android/app/Activity.html" target="_blank"><b>activity</b> </a>is "<b>.HelloJni</b>" which corresponds to "<b>HelloJni.java</b>" <b>source </b>file and is in "<b>com.example.hellojni</b>" <b><a href="http://en.wikipedia.org/wiki/Java_package" target="_blank">package</a></b>.</span><br /><span style="text-align: center;">Open "<b>HelloJni.java</b>" in any of your <b>favourite <a href="http://en.wikipedia.org/wiki/Java_(programming_language)" target="_blank">Java</a> editor</b>.</span><br /><span style="text-align: center;">Following is the code of "<b>HelloJni.java</b>":</span><br /> <pre class="brush: java"><br />package com.example.hellojni;<br /><br />import android.app.Activity;<br />import android.os.Bundle;<br />import android.widget.TextView;<br /><br />public class HelloJni extends Activity<br />{<br />  static<br />  {<br />    System.loadLibrary("hello-jni");<br />  }<br /><br />  public void onCreate(Bundle paramBundle)<br />  {<br />    super.onCreate(paramBundle);<br />    TextView localTextView = new TextView(this);<br />    localTextView.setText(stringFromJNI());<br />    setContentView(localTextView);<br />  }<br /><br />  public native String stringFromJNI();<br /><br />  public native String unimplementedStringFromJNI();<br />}<br /><br />/* Location:           classes-dex2jar.jar<br /> * Qualified Name:     com.example.hellojni.HelloJni<br /> * JD-Core Version:    0.6.2<br /> */<br /></pre><span style="text-align: center;">Its quite <b>evident </b>that the <b><a href="http://stackoverflow.com/questions/13319604/java-static-code-block" target="_blank">static code block</a></b> which gets <b>executed first </b>is loading a <b><a href="http://en.wikipedia.org/wiki/Java_Native_Interface" target="_blank">native library</a></b> named "<b>hello-jni</b>".</span><br /><span style="text-align: center;">So its full name will be "<b>libhello-jni.so</b>"</span><br /><span style="text-align: center;"><br /></span><span style="text-align: center;"><b>Step#10:</b></span><br /><span style="text-align: center;">Verifying the <b><a href="http://en.wikipedia.org/wiki/Library_(computing)" target="_blank">shared object file</a></b> "<b>libhello-jni.so</b>"</span><br /><pre class="brush: shell"><br />$ file ./lib/armeabi/libhello-jni.so<br />./lib/armeabi/libhello-jni.so: ELF 32-bit LSB shared object, ARM, version 1 (SYSV), dynamically linked, stripped<br /></pre>Also you can observe from the "<b>HelloJni.java</b>" file, that the "<b><a href="http://developer.android.com/reference/android/widget/TextView.html#setText(java.lang.CharSequence)" target="_blank">setText()</a></b>" <b><a href="http://java.wikia.com/wiki/Method" target="_blank">method </a></b>sets the <b>text</b> using the <b>native method</b> declared as:  <br /><pre class="brush: java">public native String stringFromJNI();<br /></pre><div style="text-align: center;"><u><b>DISASSEMBLING the LIBRARY FILE</b></u></div><br /><b>Step#11:</b><br />We will now look for this "<b>stringFromJNI()</b>" <b><a href="http://java.wikia.com/wiki/Method" target="_blank">method</a></b> in the disassembled view of<b> <a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA</a></b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank"> </a>inside the <b>native</b> file "<b>libhello-jni.so</b>".<br />I am running the <a href="http://en.wikipedia.org/wiki/Microsoft_Windows" target="_blank"><b>Windows</b> </a>version of <b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA </a></b>on <a href="http://en.wikipedia.org/wiki/Ubuntu_(operating_system)" target="_blank"><b>Ubuntu</b> </a>using <a href="http://en.wikipedia.org/wiki/Wine_(software)" target="_blank"><b>Wine</b> </a>but you can build and use the <a href="https://en.wikipedia.org/wiki/Linux" target="_blank"><b>Linux</b> </a>version if you want.<br /><br />Select the file to disassemble in <b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA</a></b>:</div></div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-eYwXmYZLHHk/UXltw74KycI/AAAAAAAAANY/o4wiBnJB7nU/s1600/ss5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="356" src="http://2.bp.blogspot.com/-eYwXmYZLHHk/UXltw74KycI/AAAAAAAAANY/o4wiBnJB7nU/s640/ss5.png" width="640" /></a></div><br /><br /><b>Step#12:</b><br /><div>It will detect it <b>automatically </b>as an <b><a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank">ELF </a><a href="http://en.wikipedia.org/wiki/Library_(computing)" target="_blank">Shared Object File</a></b>. Click <b>OK </b>:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-eBj5_gMDKm8/UXltxop1K0I/AAAAAAAAANg/lGvZaCLYtlw/s1600/ss6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="356" src="http://4.bp.blogspot.com/-eBj5_gMDKm8/UXltxop1K0I/AAAAAAAAANg/lGvZaCLYtlw/s640/ss6.png" width="640" /></a></div><br /><b>Step#13:</b><br /><b><a href="http://en.wikipedia.org/wiki/ARM_architecture" target="_blank">ARM </a></b>and <b>THUMB SWITCH INSTRUCTIONS </b>warning. Just click <b>OK</b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-vYJN-iKHlhM/UXltzJfXizI/AAAAAAAAANs/oxHNXJtH7IA/s1600/ss7.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://2.bp.blogspot.com/-vYJN-iKHlhM/UXltzJfXizI/AAAAAAAAANs/oxHNXJtH7IA/s640/ss7.png" width="640" /></a></div><br /><b>Step#14:</b><br />This is the <b>disassembled </b>view of the "<b>libhello-jni.so</b>" file. <b>Click </b>on the "<b>Exports</b>" <b>tab</b> for viewing all <b>functions exported </b>by this <b>library</b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-fj-4oeM5kN0/UXltzKkyCvI/AAAAAAAAANw/TabVK_tfF7w/s1600/ss8.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://1.bp.blogspot.com/-fj-4oeM5kN0/UXltzKkyCvI/AAAAAAAAANw/TabVK_tfF7w/s640/ss8.png" width="640" /></a></div><br /><b>Step#15:</b><br />Here is the list of all <b>exports</b>. The <b>Java methods </b>that are <b>made native</b> and <b>implemented</b> using this <b>library </b>are by <b>default</b> named in "<b>Java_complete_package_name_ClassName_methodName</b>" format.<br />For e.g.:<br />In our case,<b> package name</b> is "<b>com.example.hellojni</b>", <b>class name</b> is "<b>HelloJni</b>" and <b>method name</b> is "<b>stringFromJNI</b>" so the <b>function </b>name in exports will be "<b>Java_com_example_hellojni_HelloJni_stringFromJNI</b>".<br /><br />Click on this <b>function</b>, and <b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA </a></b>will show you the <b><a href="http://en.wikipedia.org/wiki/ARM_architecture" target="_blank">ARM </a><a href="https://en.wikipedia.org/wiki/Opcode" target="_blank">opcodes </a></b>for this <b>function</b>:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-0uHcTDen5Rs/UXltz7QTQoI/AAAAAAAAAN4/LwksQbw72g0/s1600/ss9.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://4.bp.blogspot.com/-0uHcTDen5Rs/UXltz7QTQoI/AAAAAAAAAN4/LwksQbw72g0/s640/ss9.png" width="640" /></a></div><br /><b>Step#16:</b><br />This is the <b>disassembled </b>view of the function. <b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA </a></b>is so <b>powerful </b>that it <b>comments </b>the code where <b>strings </b>are used. Thus as you can see that <b><a href="http://en.wikipedia.org/wiki/Interactive_Disassembler" target="_blank">IDA </a></b>has commentend our <b>string </b>(I have <b>highlighted </b>it with a <b>red box </b>below). Also we come to know that the string "<b>Hello from JNI !</b>" is <b>declared </b>as a <b>variable </b>named "<b>aHelloFromJni</b>".<br /><br /><b>Double-click</b> on "<b>aHelloFromJni</b>" and it will show you the <b>declaration </b>of string.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/--9d5X1UBRN0/UXlt1In4o_I/AAAAAAAAAOA/vZ6bRuwcxUc/s1600/ss10.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://2.bp.blogspot.com/--9d5X1UBRN0/UXlt1In4o_I/AAAAAAAAAOA/vZ6bRuwcxUc/s640/ss10.png" width="640" /></a></div><br /><b>Step#17:</b><br />As you can see, "<b>aHelloFromJni</b>" is <b>defined </b>as "<b>Hello from JNI !</b>" with the <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0489c/Checdgjh.html" target="_blank"><b>DCB</b> </a><b><a href="http://en.wikipedia.org/wiki/Assembly_language#Assembly_directives" target="_blank">assembler directive</a></b>.<br /><br /><b><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0489c/Checdgjh.html" target="_blank">DCB </a></b>is an <b><a href="http://en.wikipedia.org/wiki/ARM_architecture" target="_blank">ARM </a><a href="http://en.wikipedia.org/wiki/Assembly_language#Assembly_directives" target="_blank">Assembler Directive</a> </b>that stands for <b><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0489c/Checdgjh.html" target="_blank">Define Constant Byte</a></b>.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-6a-nbMthIDg/UXlt1-l9DLI/AAAAAAAAAOI/aVKut0hZKcY/s1600/ss11.0.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://3.bp.blogspot.com/-6a-nbMthIDg/UXlt1-l9DLI/AAAAAAAAAOI/aVKut0hZKcY/s640/ss11.0.png" width="640" /></a></div><br /><b>Step#18:</b><br />&nbsp;Now click on the "<b>Hex View</b>" tab, and you will see the <b><a href="https://en.wikipedia.org/wiki/Hex_dump" target="_blank">Hex Dump</a></b> for the defined <b>string</b>.<br />Click on the <b>first character </b>of the string i.e. '<b>H</b>', and at the <b>status bar </b>at the <b>bottom </b>you will get the <b><a href="http://en.wikipedia.org/wiki/Offset_(computer_science)" target="_blank">file offset</a> </b>of the <b>beginning </b>of the string <b>literal</b>.<br /><br />In this case it is <b>0x2030</b>.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-CXN5G_JkT1g/UXlt3HamTaI/AAAAAAAAAOU/HOsavyb3dnQ/s1600/ss11.1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://1.bp.blogspot.com/-CXN5G_JkT1g/UXlt3HamTaI/AAAAAAAAAOU/HOsavyb3dnQ/s640/ss11.1.png" width="640" /></a></div><br /><div style="text-align: center;"><u><b>MODIFYING the LIBRARY FILE</b></u></div><u><br /></u><b>Step#19:</b><br />Using any of your favourite <b><a href="http://en.wikipedia.org/wiki/Hex_editor" target="_blank">Hex Editor</a>&nbsp;</b>(I have used <b><a href="http://home.gna.org/bless/" target="_blank">Bless Hex Editor</a></b>), open the file "<b>libhello-jni.so</b>" and go to <b><a href="http://en.wikipedia.org/wiki/Offset_(computer_science)" target="_blank">file offset</a> 0x2030</b>.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-EFMbkOmK9B4/UXlt3XnpyHI/AAAAAAAAAOY/_lIdWIA3CiE/s1600/ss12.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://4.bp.blogspot.com/-EFMbkOmK9B4/UXlt3XnpyHI/AAAAAAAAAOY/_lIdWIA3CiE/s640/ss12.png" width="640" /></a></div><br /><b>Step#20:</b><br />Replace the <b>original </b>string bytes with <b>new </b>bytes and <b>save </b>the file.<br />I have <b>replaced </b>the <b>original </b>string "<b>Hello from JNI !</b>" with "<b>Bye.. from JNI !</b>"<br /><b><span style="color: red;">Warning#1</span></b>: As it is a <b><a href="http://en.wikipedia.org/wiki/Binary_file" target="_blank">binary</a>&nbsp;<a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank">ELF</a> <a href="http://en.wikipedia.org/wiki/Library_(computing)" target="_blank">shared object file</a></b>, take care that you <b>replace </b>only the <b>original </b>bytes in the string "<b>Hello from JNI !</b>" starting from the <b><a href="http://en.wikipedia.org/wiki/Offset_(computer_science)" target="_blank">offset</a> 0x2030</b> till <b>0x203F</b>.<br /><b><span style="color: red;">Warning#2</span></b>: Also see that you "<b>REPLACE</b>" and not "<b>INSERT</b>".<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-TnQw-rHB58E/UXlt4p3PhVI/AAAAAAAAAOo/485KxtKMIKI/s1600/ss13.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="358" src="http://3.bp.blogspot.com/-TnQw-rHB58E/UXlt4p3PhVI/AAAAAAAAAOo/485KxtKMIKI/s640/ss13.png" width="640" /></a></div><br /><div style="text-align: center;"><b style="font-family: 'Times New Roman'; white-space: normal;"><u><a href="http://developer.android.com/tools/publishing/app-signing.html" target="_blank">RE-SIGNING the APK FILE</a></u></b></div><br />Now as we have modified the "<b>libhello-jni.so</b>" file we need to <b>update </b>the <b>modified file </b>in the "<b>crackme.native-1.apk</b>" file and also <b><a href="http://developer.android.com/tools/publishing/app-signing.html" target="_blank">resign</a> </b>the "<b>crackme.native-1.apk</b>" !<br /><br /><b>Step#21:</b><br /><b>Updating </b>the modified <b>library </b>file inside the <b><a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">.apk</a> </b>file.  <br /><pre class="brush: shell">$ zip ../crackme.native-1.apk -u lib/armeabi/libhello-jni.so <br />updating: lib/armeabi/libhello-jni.so<br /> zip warning: Local Entry CRC does not match CD: lib/armeabi/libhello-jni.so<br /> (deflated 61%)<br /></pre><b>Step#22:</b><b><a href="http://developer.android.com/tools/publishing/app-signing.html" target="_blank">Re-signing</a></b> the updated .apk file.  <br /><pre class="brush: shell"><br />$ cd ..<br />$ java -jar ./tools/signapk.jar ./tools/testkey.x509.pem ./tools/testkey.pk8 crackme.native-1.apk crackme.native-1-SIGNED.apk<br /></pre><br /><div style="text-align: center;"><b><u>TESTING the MODIFIED CRACKME</u></b></div><br /><b>Merely </b>installing the new crackme will give <b>error </b>as the<b><a href="http://en.wikipedia.org/wiki/Fully_qualified_name" target="_blank"> fully qualified name</a></b> of both the <b>original </b>and <b>modified <a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme </a></b>will conflict because of being same (<b>com.example.hellojni</b>).<br />So <b>before </b>installing our <b>modified apk</b>, we need to <b>uninstall </b>the previous one.<br /><br /><b>Step#23:</b><br /><b>Uninstall </b>the previous <b><a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme</a> </b>manually by navigating to "<b>Settings</b>"<b> ==&gt;</b> "<b>Manage Applications</b>".  <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-fa5EYSf2N3Q/UXlt4nnfSPI/AAAAAAAAAOk/K1C2t6V4gpY/s1600/ss14.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-fa5EYSf2N3Q/UXlt4nnfSPI/AAAAAAAAAOk/K1C2t6V4gpY/s1600/ss14.png" /></a></div><br /><br />In order to test our new modified <a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">apk</a>, we need to go to "<b>platform-tools</b>" directory of the <b><a href="http://developer.android.com/sdk/index.html" target="_blank">SDK</a></b>:<br /><pre class="brush: shell"><br />$ cd /opt/android/adt-bundle-linux-x86/sdk/platform-tools/<br /></pre><span style="color: red;">P.S.: The emulator is still running.</span><br /><div><br /></div><div><b>Step#24:</b></div><div><div style="text-align: left;">Install modified <b><a href="http://en.wikipedia.org/wiki/APK_(file_format)" target="_blank">APK</a> </b>(<b>crackme.native-1-SIGNED.apk</b>) in Emulator using <b><a href="http://developer.android.com/tools/help/adb.html" target="_blank">adb</a></b>.</div></div><pre class="brush: shell"><br />$ ./adb install /home/shubhuntu/mycracklab/crackme.native-1-SIGNED.apk <br />970 KB/s (153453 bytes in 0.154s)<br /> pkg: /data/local/tmp/crackme.native-1-SIGNED.apk<br />Success<br /></pre><div><div><br /></div></div><div><b>Step#25:</b></div><div><div style="text-align: left;">Click the icon to run the <a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme</a>.</div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-IcXD3zbOFmw/UXlt5bIpVZI/AAAAAAAAAOw/O5IXOKwAmNk/s1600/ss15.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-IcXD3zbOFmw/UXlt5bIpVZI/AAAAAAAAAOw/O5IXOKwAmNk/s1600/ss15.png" /></a></div><br /></div>