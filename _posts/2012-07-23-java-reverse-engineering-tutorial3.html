---
layout: post
title: 'Java Reverse Engineering Tutorial#3: Cracking simple password check using
  bytecode patching'
date: '2012-07-23T22:41:00.000+05:30'
author: Shubham Aher
tags:
- java
- cracking
- reverse engineering
- tutorial
modified_time: '2013-01-13T17:28:55.969+05:30'
thumbnail: http://2.bp.blogspot.com/-lCkhcmtSppg/UAxiEShGF8I/AAAAAAAAAAk/2jpR4ULM7hc/s72-c/sshot-2.png
blogger_id: tag:blogger.com,1999:blog-2487333153967243269.post-6434182672376210990
blogger_orig_url: http://shubhamaher.blogspot.com/2012/07/java-reverse-engineering-tutorial3.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><h4 style="text-align: left;">   <u> Aim:</u></h4>In this tutorial we will learn how to patch the bytecode present in the class file of the simple crackme which we used in the <a href="http://www.shubhamaher.blogspot.in/2012/07/java-reverse-engineering-tutorial2.html" target="_blank">previous</a> tutorial.<br /><br /><h4>   <u>Input:</u></h4><div>You are given a simple&nbsp;<a href="http://en.wikipedia.org/wiki/Crackme" target="_blank">crackme</a>&nbsp;(Java .class file)</div><div><br /></div><h4>    <u>Tools:</u></h4><div><ul><li><a href="http://www.mediafire.com/download.php?2bw6mh49t9753ig" target="_blank">JavaBite</a> - My favourite Java bytecode viewer/editor</li></ul><h4 style="text-align: left;">    <u style="background-color: white;">Tutorial:</u></h4><div><ol><li>Lets first run the given crackme file (<a href="http://www.mediafire.com/download.php?hz72egbh9jfr0r2" target="_blank">SimplePasswordCheck.class</a>) and see what happens:</li></ol><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-lCkhcmtSppg/UAxiEShGF8I/AAAAAAAAAAk/2jpR4ULM7hc/s1600/sshot-2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-lCkhcmtSppg/UAxiEShGF8I/AAAAAAAAAAk/2jpR4ULM7hc/s1600/sshot-2.png" /></a></div></div><div><br /></div><div>2. If we type "john" as password, it results in "ACESS DENIED" that means the password "john" is wrong.<br /><br />3. Now open the class file in <a href="http://www.mediafire.com/download.php?2bw6mh49t9753ig" target="_blank">JavaBite</a> by&nbsp;<span style="background-color: white;">navigating to <i>'Classes | Add Java Class'</i> in the menu</span><span style="background-color: white;">. We will not use any java decompiler(like we did in previous tutorial) as we are going to study the class file at a more granular i.e. assembly(java opcode) level.</span><br /><br />4. After opening the file you will see something like this:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-FXl2Ak0b68k/UA1cnGVmB4I/AAAAAAAAAB0/HLnObHq9L8Q/s1600/sshot-1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="181" src="http://4.bp.blogspot.com/-FXl2Ak0b68k/UA1cnGVmB4I/AAAAAAAAAB0/HLnObHq9L8Q/s400/sshot-1.png" width="400" /></a></div><br /><br />5. In the left-hand side column, expand the tree by navigating from the class file to <i>'Methods | main'</i>. After selecting <i>'main'</i>, the bytecodes of <i>'main()'</i> method will be loaded in the right-hand side column. This is the opcode/assembly representation of the body of the <i>'main()'</i> method. After loading, it should like this:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-DtE0pT-s270/UA1dp3lURYI/AAAAAAAAAB8/JKjyQYwSo3k/s1600/sshot-2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="221" src="http://4.bp.blogspot.com/-DtE0pT-s270/UA1dp3lURYI/AAAAAAAAAB8/JKjyQYwSo3k/s400/sshot-2.png" width="400" /></a></div><br />6. In the loaded bytecode, there are 3 columns:<br /><div style="text-align: left;"></div><ol style="text-align: left;"><li><i>'#'</i> - The bytecode index (in hex).</li><li><i>'ByteCode'</i> - The actual hex representation of the bytcode.</li><li><i>'Disassembled'</i> - The disassembled representation of the java opcodes.</li></ol>7. All the words like <i>'new', 'dup', 'getstatic', 'invokespecial', 'astore_1', 'ldc', 'invokevirtual', 'ifeq', 'goto', 'return'</i> are infact the java opcodes. In order to understand them properly you should go through the <i><b><a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions.doc.html" target="_blank">'Java Virtual Machine Instruction Set'</a></b></i>.<br /><div style="text-align: left;"><br /></div><div style="text-align: left;">8. As we have know from the previous tutorial that this crackme has 'shubham' as the password, we see the same string as being the argument to <i>'ldc'</i> instruction at bytecode index <i>'000B'</i> in the loaded bytecode.(See below):<br /><br /></div><div style="text-align: left;"><br /><table border="1" cellpadding="0" cellspacing="0" class="MsoTableGrid" style="border-collapse: collapse; border: none; mso-border-alt: solid black .5pt; mso-border-themecolor: text1; mso-padding-alt: 0in 5.4pt 0in 5.4pt; mso-yfti-tbllook: 1184;"> <tbody><tr>  <td style="border: solid black 1.0pt; mso-border-alt: solid black .5pt; mso-border-themecolor: text1; mso-border-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;">#<o:p></o:p></div></td>  <td style="border-left: none; border: solid black 1.0pt; mso-border-alt: solid black .5pt; mso-border-left-alt: solid black .5pt; mso-border-left-themecolor: text1; mso-border-themecolor: text1; mso-border-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;">ByteCode<o:p></o:p></div></td>  <td style="border-left: none; border: solid black 1.0pt; mso-border-alt: solid black .5pt; mso-border-left-alt: solid black .5pt; mso-border-left-themecolor: text1; mso-border-themecolor: text1; mso-border-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;">Disassembled<o:p></o:p></div></td> </tr><tr>  <td style="border-top: none; border: solid black 1.0pt; mso-border-alt: solid black .5pt; mso-border-themecolor: text1; mso-border-themecolor: text1; mso-border-top-alt: solid black .5pt; mso-border-top-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">000B<o:p></o:p></div></td>  <td style="border-bottom: solid black 1.0pt; border-left: none; border-right: solid black 1.0pt; border-top: none; mso-border-alt: solid black .5pt; mso-border-bottom-themecolor: text1; mso-border-left-alt: solid black .5pt; mso-border-left-themecolor: text1; mso-border-right-themecolor: text1; mso-border-themecolor: text1; mso-border-top-alt: solid black .5pt; mso-border-top-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">1205<o:p></o:p></div></td>  <td style="border-bottom: solid black 1.0pt; border-left: none; border-right: solid black 1.0pt; border-top: none; mso-border-alt: solid black .5pt; mso-border-bottom-themecolor: text1; mso-border-left-alt: solid black .5pt; mso-border-left-themecolor: text1; mso-border-right-themecolor: text1; mso-border-themecolor: text1; mso-border-top-alt: solid black .5pt; mso-border-top-themecolor: text1; padding: 0in 5.4pt 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">ldc #0005&lt;shubham&gt;<o:p></o:p></div></td> </tr></tbody></table></div></div></div><br />See the specification for the <i>'ldc'</i> instruction at&nbsp;<a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions2.doc8.html" target="_blank">http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions2.doc8.html</a><br /><br /><b>Short Explanation:</b> The argument (number) <i>'0005'</i> is a reference to the string literal&nbsp;<i>"shubham"</i> in the <i><b><a href="http://en.wikipedia.org/wiki/Java_class_file#The_constant_pool" target="_blank">constant pool</a></b></i> of the loaded class file.<br /><br />9. Traversing down in the loaded opcodes, we see a line of our interest the <i>'ifeq'</i> check ! This is the appropriate line to patch as it is a validation check for the password.<br /><br /><br /><div><table border="1" cellpadding="0" cellspacing="0" class="MsoTableGrid" style="border-collapse: collapse; border: none;"><tbody><tr><td style="border: 1pt solid black; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;"><b>#<o:p></o:p></b></div></td><td style="border: 1pt solid black; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;"><b>ByteCode<o:p></o:p></b></div></td><td style="border: 1pt solid black; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div align="center" class="MsoNormal" style="margin-bottom: 0.0001pt; text-align: center;"><b>Disassembled</b><o:p></o:p></div></td></tr><tr><td style="border: 1pt solid black; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">0020<o:p></o:p></div></td><td style="border-bottom-color: black; border-bottom-width: 1pt; border-right-color: black; border-right-width: 1pt; border-style: none solid solid none; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">99000E<o:p></o:p></div></td><td style="border-bottom-color: black; border-bottom-width: 1pt; border-right-color: black; border-right-width: 1pt; border-style: none solid solid none; padding: 0in 5.4pt; width: 159.6pt;" valign="top" width="213"><div class="MsoNormal" style="margin-bottom: 0.0001pt;">ifeq 0000002E<o:p></o:p></div></td></tr></tbody></table></div><div>See the specification for the <i>'if&lt;cond&gt;'</i> instruction at&nbsp;<a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions2.doc6.html" target="_blank">http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions2.doc6.html</a></div><div><br /><div style="text-align: -webkit-auto;"><b style="background-color: white; font-weight: bold;">Short Explanation:</b><span style="background-color: white;">&nbsp;The <i>eq succeeds if and only if value = 0. </i>That means if the comparison with 0(false) succeeds then it branches to the address given in the argument. So in above e.g., if the condition is <i>false</i> then it jumps to bytecode index <i>'0000002E' </i>that is at line:</span></div><div style="text-align: -webkit-auto;"><span style="background-color: white;"><br /></span></div><div style="text-align: -webkit-auto;"><span style="background-color: white;"><i><b>002E &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;B20006 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;getstatic #0006&lt;java.io.PrintStream java.lang.System.out&gt;'</b></i></span></div><div style="text-align: -webkit-auto;"><span style="background-color: white;"><i><b><br /></b></i></span></div><div style="text-align: -webkit-auto;"><span style="background-color: white;">10. Next we see that the string <i>"ACCESS DENIED :-("</i> is loaded. This confirms that the current line(bytecode index <i>'0031'</i>) is the line inside the <i>'else'</i> block of the <i>'if-else'</i> statement.</span></div><div style="text-align: -webkit-auto;"><br /></div><div style="text-align: -webkit-auto;">11. So we now, actually patch the <i>'ifeq'</i> line at bytecode index <i>'0020'</i> as shown below:</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-CuwPiPCqvI0/UA1oDTk6RZI/AAAAAAAAACI/XJMDGxdgOYQ/s1600/sshot-3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="238" src="http://4.bp.blogspot.com/-CuwPiPCqvI0/UA1oDTk6RZI/AAAAAAAAACI/XJMDGxdgOYQ/s400/sshot-3.png" width="400" /></a></div><div style="text-align: -webkit-auto;"><br /></div><div style="text-align: -webkit-auto;">&nbsp;Select the line. Righclick and choose <i>'Edit instruction'</i>.</div><div style="text-align: -webkit-auto;"><br /></div><div style="text-align: -webkit-auto;">12. Now the <i>'Edit Instruction'</i> box will pop up. Select <i>'ifne'</i> from the <i>'Instruction'</i> dropdown list.</div><div style="text-align: -webkit-auto;"><br /></div><div style="text-align: -webkit-auto;">13. Also double click the <i>'BRANCH_OFFSET' </i>item in the <i>'Parameters'</i> tab and a <i>'Edit Branch Offset'</i> box will pop up. Select <i>'002E - getstatic'</i> from the <i>'Branch to line' </i>dropdown list of the <i>'Branch Offset'</i> tab.(see below)</div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Ll4Fxh3YSec/UA1pzfpE2YI/AAAAAAAAACQ/4DQEySsIXFk/s1600/sshot-4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="292" src="http://4.bp.blogspot.com/-Ll4Fxh3YSec/UA1pzfpE2YI/AAAAAAAAACQ/4DQEySsIXFk/s400/sshot-4.png" width="400" /></a></div><div style="text-align: -webkit-auto;"><br /></div><div style="text-align: -webkit-auto;">14. Thats it!&nbsp;</div><div style="text-align: -webkit-auto;"><br /></div><h4 style="text-align: left;">   <u>Conclusion:</u></h4><div style="text-align: -webkit-auto;">We have changed the <i>'ifeq'</i> conditional instruction to the <i>'ifne'</i> conditional instruction i.e. we have <u><b>inverted</b></u> the conditional check. But why ? What we have done is that we have <b>patched</b> the crackme such that for every password input <b>other than the original(<i>"shubham"</i>)</b> the crackme will result in displaying the message <i>"ACCESS GRANTED :-)"</i> that means for any password(except original) the true case of <i>if-else</i> check is executed.</div><div style="text-align: -webkit-auto;"><br /></div><h4 style="text-align: left;">   <u>Notes:</u></h4><div style="text-align: -webkit-auto;">If you have not understood this tutorial then you must be <b>lacking</b> the knowledge of Java opcodes. Please go thoroughly from&nbsp;<span style="background-color: white; text-align: left;">the&nbsp;</span><i style="background-color: white; text-align: left;"><b><a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions.doc.html" target="_blank">'Java Virtual Machine Instruction Set'</a>.</b></i></div><div style="text-align: -webkit-auto;"><span style="background-color: white; text-align: left;"><br /></span></div><h4 style="text-align: left;">   <span style="background-color: white; text-align: left;"><u>Downloads/Links:</u></span></h4><div style="text-align: -webkit-auto;"><ul style="text-align: left;"><li><a href="http://www.mediafire.com/download.php?2bw6mh49t9753ig" target="_blank">JavaBite</a></li><li><a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Instructions.doc.html" target="_blank">Java Virtual Machine Instruction Set</a></li></ul></div></div></div>